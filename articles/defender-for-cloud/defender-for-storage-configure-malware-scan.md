---
title: Configure Malware Scanning - Microsoft Defender for Cloud
description: Learn about how to configure malware scanning to prevent harmful files from being uploaded to Azure Storage.
ms.date: 03/16/2023
author: bmansheim
ms.author: benmansheim
ms.topic: how-to
---

# Configure Malware Scanning

Malware scanning provides a way to prevent harmful files from being uploaded to Azure Storage. Malware scanning is a built-in SaaS solution that allows simple enabling at scale with zero maintenance. It is designed to help fulfill security and compliance requirements to scan untrusted content uploaded to storage, including an option to log every scan result.

Learn more about [Malware Scanning in Defender for Storage](defender-for-storage-malware-scan.md).

## Prerequisites

To use malware scanning you'll need to [enable Defender for Storage](defender-for-storage-classic-enable.md).

## Setting up Malware Scanning

When Malware Scanning is enabled, the following actions automatically take place in your environment:

- For each storage account you enable Malware Scanning on, an Event Grid System Topic resource is created in the same resource group of the storage account - used by the Malware Scanning service to listen on blob upload triggers. Removing this resource will break the Malware Scanning functionality.

- To scan your data, the Malware Scanning service requires access to your data. During service enablement, a new Data Scanner resource called "StorageDataScanner" is created in your Azure subscription and assigned with a system managed identity. This resource is granted “Blob data owner” role to access and change your data for Malware Scanning and Sensitive Data Discovery.

In case your storage account “Networking configuration” is set to “Enable Public network access from selected virtual networks and IP addressed”, the “StorageDataScanner” resource will be added to the “Resource instances” section under storage account “Networking” configuration to allow access to scan you data.

In case you are enabling Malware Scanning on the subscription level, a new resource Security Operator resource called “StorageAccounts/securityOperators/DefenderForStorageSecurityOperator” is created in your Azure subscription and assigned with a system managed identity. This resource is used to enable and repairer Defender for Storage and Malware Scanning configuration on existing storage account in addition to check for new storage accounts created in the subscription to be enabled. This resource will have role assignments that includes the [specific permissions](#prerequisites) needed to enable Malware Scanning.

> [!NOTE]
> Removing these resources or changing the identity or networking will break the Malware Scanning functionality. To heal from such an issue, you can simply disable and re-enable Malware Scanning.

## Responding to Malware Scanning scan results

### Blob index tags

[Blob index tags](../storage/blobs/storage-blob-index-how-to.md) are metadata fields on a blob. They categorize data in your storage account using key-value tag attributes. These tags are automatically indexed and exposed as a searchable multi-dimensional index to easily find data. The scan results are concise, displaying “Malware Scanning scan result” and “Malware Scanning scan time UTC” in the blob metadata. Other result types (alerts, events, logs) provide more information on the malware type and file upload operation.

Malware Scanning Index Tags Keys added:

- Malware Scanning scan result possible values:

    - `No threats found`
    - `Malicious`
    - `SAM259210: Scan aborted - <message> Correlation Id: <correlation-id-guid>`
    - `SAM259210: Scan failed - <message> Correlation Id: <correlation-id-guid>`
    - `SAM259210: Scan timed out - <message> Correlation Id: <correlation-id-guid>`
        In case of issues, you might be requested by Microsoft support to provide this `<correlation-id-guid>` for troubleshooting.

- Malware Scanning scan time UTC possible values:

    - The time and date of the scan. Format: yyyy-MM-dd HH:mm:ssZ

> [!NOTE]
> - blob index tags are not tamper-resistant. Blob index tags can be edited by anyone with the Storage Blob Data Owner built-in role, or anyone with the blob/tags/write permission. All other result types are tamper-proof (can only be changed by Microsoft Defender)
> - Index tags are not supported for premium block blobs and ADLS Gen2.

Blob index tags can be used by applications to automate workflows. Read more on setting up response.

### Configure automated response

Set up automated responses to move or remove malicious files or to move/ingest clean files to another destination. Select the preferred response option that fits your scenario architecture.

With Malware Scanning, you can build your automation response using the following scan result options:

- Defender for Cloud security alerts
- Event Grid events
- Blob index tags

Here are some response options that you can use to automate your response.

#### Delete or move a malicious blob

You can use code or workflow automation to delete or move malicious files to quarantine.

1. Prepare your environment for delete or move.

    - **Delete the malicious file** - Before setting up automated deletion, enabling soft delete on the storage account is recommended. It will allow to “undelete” files in case of false positives or in cases where security professionals want to investigate the malicious files.

    - **Move the malicious file to quarantine** - You can move files to a dedicated storage container or storage account that will be regarded as “quarantine”.

        You may want only certain users, such as a security admin or a SOC analyst, to have permission to access this dedicated container or storage account.

        - Using AAD (Azure Active Directory) to control access to blob storage is considered a best practice.

            To control access to the dedicated quarantine storage container, you can use container-level role assignments using AAD RBAC.

            Users with storage account-level permissions may still be able to access the “quarantine” container. You can either edit their permissions to be container-level or choose a different approach and move the malicious file to a dedicated storage account.

        - If you must use other methods, such as SAS (shared access signatures) tokens on the protected storage account, it is best practice to move malicious files to another storage account (quarantine).

            Then, it is best only to grant AAD permission to access the quarantined storage account.

#### Set up automation

##### Option 1: Logic App based on Microsoft Defender for Cloud security alerts

Logic App based responses are a simple, no-code approach to setting up response. However, the response time is slower than the event-driven code-based approach (see below).

1. Deploy the [DeleteBlobLogicApp](https://portal.azure.com/#create/Microsoft.Template/uri/https%3A%2F%2Fstorageantimalwareprev.blob.core.windows.net%2Fworkflows%2FDeleteBlobLogicApp-template.json****) Azure Resource Manager (ARM) template using the Azure portal.

1. Add role assignment to the Logic App to allow it to delete blobs from your storage account:

    1. Go to “Identity” in the side menu and click on “Azure role assignments”.

    1. Add role assignment in the subscription level with the “Storage Blob Data Contributor” role.

    1. Create workflow automation for Microsoft Defender for Cloud alerts:

        1. Go to “Microsoft Defender for Cloud” in the Azure portal.

        1. Go to “workflow automations” in the side menu.

        1. Add a new workflow. In the “Alert name contains” field, fill in “Malicious file uploaded to storage account” and choose your Logic app in the “Actions” section.

##### Option 2: Function App based on Event Grid events

A Function App provides high performance with a low latency response time.

1. Create a [Function App](../azure-functions/functions-overview.md) in the same resource group as your protected storage account.

1. Add role assignment for the Function app identity.

    1. Go to “Identity” in the side menu, make sure the “System assigned” identity status is ON, and click on “Azure role assignments”.

    1. Add role assignment in the subscription or storage account levels with the “Storage Blob Data Contributor” role.

1. Consume Event Grid events and connect an Azure Function as the endpoint type.

1. When writing the Azure Function code, you can use our premade function sample - [MoveMaliciousBlobEventTrigger](https://storageantimalwareprev.blob.core.windows.net/samples/MoveMaliciousBlobEventTrigger.cs), or [write your own code](../storage/blobs/storage-blob-copy.md) to copy the blob elsewhere, then delete it from the source.

#### Make your applications and data flows aware of Malware Scanning scan results

Malware Scanning is near real-time, and usually, there is a small time window between the time of the upload and the time of the scan.
Because storage is non-compute, there is no risk that malicious files will be executed in your storage. The risk is users or applications accessing malicious files and spreading them throughout the organization.

Below are two methods to make your applications and data flows aware of Malware Scanning scan results and ensure there is no way to access/process a file before it has been scanned and its result has been consumed and acted on.

##### Applications ingest data based on the scan result

###### Option 1: Apps checking “Index tag” before processing

One way to achieve this is to update all the applications that access the storage account. Each application will now check the scan result for each file, and if the blob “Index tag” scan result is “no threats found”, the application reads the blob.

###### Option 2: Connect your application to a Webhook in Event Grid events

You can connect your application to a Webhook in Event Grid events and use those events to trigger the relevant processes for files that have “no thread found” scan results.
Learm more about using [Webhook event delivery and validating your endpoint](../event-grid/webhook-event-delivery.md).

###### Use an intermediary storage account as a DMZ

You can set up an intermediary storage account for untrusted content (DMZ) and direct uploading traffic to the DMZ.

On the untrusted storage account, enable Malware Scanning and connect Event Grid and Function App to move only blobs scanned with the “no threat found” result to the destination storage account.










## Next steps

In this article, you learned about Microsoft Defender for Storage.

> [!div class="nextstepaction"]
> [Enable Defender for Storage](enable-enhanced-security.md)
